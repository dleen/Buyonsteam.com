@(gamePrices: List[(Game, Option[Price])], priceStats: PriceStats)

@import play.api.libs.json.Json._


@nicePrice(price: Double) = @{
	val dot = price.toString.indexOf('.')
	val np  = price.toString + "0000000"

	if (dot == 1) np.slice(0,4)
	else if (dot == 2) np.slice(0,5)
	else if (dot == 3) np.slice(0,6)
	else "0"
}

<!DOCTYPE html>

<html lang="en">
<head>
	<title>Buy Or Wait</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
	<link rel="stylesheet" type="text/css" media="screen" href="@routes.Assets.at("stylesheets/bootstrap.min.css")">
	<link rel="stylesheet" type="text/css" media="screen" href="@routes.Assets.at("stylesheets/bootstrap-responsive.css")">
	<link rel="stylesheet" type="text/css" media="screen" href="@routes.Assets.at("stylesheets/jquery-ui-1.9.1.custom.css")">
	<link rel="stylesheet" media="screen" href="@routes.Assets.at("stylesheets/main.css")">
	<link rel="shortcut icon" type="image/png" href="@routes.Assets.at("images/favicon.png")">
	<link rel="shortcut icon" type="image/png" href="@routes.Assets.at("img/glyphicons-halflings.png")">
	<link rel="shortcut icon" type="image/png" href="@routes.Assets.at("img/glyphicons-halflings-white.png")">
	<style type="text/css">
	.bar rect {
		fill: steelblue;
	}
	.bar text.value {
		fill: white;
	}
	.axis {
		shape-rendering: crispEdges;
	}
	.axis path {
		fill: none;
	}
	.x.axis line {
		stroke: #fff;
		stroke-opacity: .8;
	}
	.y.axis path {
		stroke: black;
	}
	</style>
</head>
<body>

	<div class="container-narrow" id="main-div">

		<div class="row-fluid">
			<div id="my-hero">
				<h1>@{if (gamePrices.isEmpty) "No Name" else gamePrices.head._1.name }</h1>
			</div>
			<div id="small-search">
				<form class="form-search" action="@routes.Application.gameP()">
					<input type="search" id="searchbox" class="input-large autocomplete" name="g" placeholder="Search for a game..." data-url="@{routes.Application.autocompleteSearch()}" autocomplete="off">
				</form>
			</div>
		</div>



		<div class="row-fluid">
			<div class="span12 well" id="recc">
				<h3>Recommendation: <font color="#51a351">buy</font> or <font color="#bd362f">don't buy</font> on Steam or neutral</h3>
			</div>
		</div>

		<div class="row-fluid">
			<div class="span6">
				@Option(gamePrices).filterNot(_.isEmpty).map { x =>
				<table class="table table-striped table-hover" id="table-5">
					<thead>
						<tr>
							<th><h4>Store</h4></th>
							<th><h4>Price</h4></th>
							<th><h4>Price</h4></th>
						</tr>
					</thead>
					<tbody>
						@x.map { 
						case (game, price) => {
						<tr>
							<td>@game.store</td>
							<td><a href="@game.storeUrl">@game.name</a></td>
							<td>$@price.map(z => nicePrice(z.priceOnX)).getOrElse{<em>n/a</em>}</td>
						</tr>
					}
				}
			</tbody>
		</table>
	}.getOrElse{
	<div class="well" id="recc">
		<em>Nothing on sale today!</em>
	</div>
}
</div>
<div class="span6">
	<table class="table table-hover">
		<thead>
			<tr>
				<th colspan="2"><h4>Price Stats</h4></th>
				<th><h4>Store</h4></th>
				<th><h4>When</h4></th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>Average</td>
				<td>$@nicePrice(priceStats.avg)</td>
				<td></td>
				<td></td>
			</tr>
			<tr class="success">
				<td>Lowest</td>
				<td>$@nicePrice(priceStats.min)</td>
				<td>@priceStats.smin</td>
				<td>@priceStats.minD</td>
			</tr>
			<tr class="error">
				<td>Highest</td>
				<td>$@nicePrice(priceStats.max)</td>
				<td>@priceStats.smax</td>
				<td>@priceStats.maxD</td>
			</tr>
		</tbody>
	</table>
</div>
</div>

<div class="row-fluid">
	<div id="chart-cont"></div>
</div>

<div class="row-fluid">
	<div id="d3-chart-cont"></div>
</div>

</div>

<script src="@routes.Assets.at("javascripts/jquery.min.js")"></script> 
<script src="@routes.Assets.at("javascripts/jquery-ui-1.9.1.custom.min.js")"></script> 
<script src="@routes.Assets.at("javascripts/bootstrap.min.js")"></script> 
<script src="http://code.highcharts.com/highcharts.js"></script>
<script src="http://code.highcharts.com/modules/exporting.js"></script>
<script>    
$('input.autocomplete').each( function() {
	var $input = $(this);
	var serverUrl = $input.data('url');
	$input.autocomplete({ source:serverUrl });
});
</script>
<script type="text/javascript">
$(function () {
var chart; // globally available
$(document).ready(function() {

	$.getJSON("@routes.Application.priceData(gamePrices.head._1.name)", function(data) {
		chart = new Highcharts.Chart({
			chart: {
				renderTo: 'chart-cont',
				type: 'line',
				backgroundColor: null
			},

			xAxis: {
				type: 'datetime',
            	dateTimeLabelFormats: { // don't display the dummy year
            	day: '%e. %b',
            	week: '%e. %b'
        		}
    		},

    		yAxis: {
    			title: {
    				text: 'Price'
    			}
    		},

            plotOptions: {
                line: {
                    dataLabels: {
                        enabled: true
                    }
                }
            },

    		credits: {
    			enabled: false
    		},

    		series: data
		});
	});
});
});
</script>
<script src="http://d3js.org/d3.v2.min.js"></script>
<script type="text/javascript">
function log(msg) {
	setTimeout(function() {
		throw new Error(msg);
	}, 0);
};

	var data   = jQuery.parseJSON('@Html(toJson(gamePrices.map(x => toJson(Map("store" -> toJson(x._1.store), "price" -> toJson(x._2.get.priceOnX))))).toString)');

	var x = d3.scale.linear()
	.range(["0%", "100%"]);

	var y = d3.scale.ordinal()
	.rangeBands([0, 100]);

	var xAxis = d3.svg.axis()
    	.scale(x)
    	.orient("top")
    	.tickSize(-10);

	var yAxis = d3.svg.axis()
    	.scale(y)
    	.orient("left")
    	.tickSize(0);

	var svg = d3.select("#d3-chart-cont").append("svg")
	.attr("class", "chart")
	.attr("width", "100%")
	.append("g");

	x.domain([0, d3.max(data, function(d) { return d.price; })]);
	y.domain(data.map(function(d) { return d.store; }));

	svg.attr("height", 20 * data.map(function(d) { return d.store; }).length);

	var bar = svg.selectAll("g.bar")
		.data(data)
		.enter().append("g")
		.attr("class", "bar")
		.attr("transform", function(d) { return "translate(0," + y(d.store) + ")"; });

	bar.append("rect")
		.attr("width", function(d) { return x(d.price); })
		.attr("height", y.rangeBand());

	bar.append("text")
	   .attr("class", "value")
       .attr("x", function(d) { return x(d.price); })
       .attr("y", y.rangeBand() / 2)
       .attr("dx", -3)
       .attr("dy", ".35em")
       .attr("text-anchor", "end")
       .text(function(d) { return d.price; });

	svg.append("g")
    	.attr("class", "x axis")
    	.call(xAxis);

	svg.append("g")
    	.attr("class", "y axis")
    	.call(yAxis);
    </script>
</body>
</html>