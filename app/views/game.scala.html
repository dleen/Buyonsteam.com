@(gamePrices: List[(Game, Price)], priceStats: PriceStats)

@import play.api.libs.json.Json._

@nicePrice(price: Double) = @{
	val dot = price.toString.indexOf('.')
	val np  = price.toString + "0000000"

	if (dot == 1) np.slice(0,4)
	else if (dot == 2) np.slice(0,5)
	else if (dot == 3) np.slice(0,6)
	else "0"
}

<!DOCTYPE html>

<html lang="en">
<head>
	<title>Buy Or Wait</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
	<link rel="stylesheet" type="text/css" media="screen" href="@routes.Assets.at("stylesheets/bootstrap.min.css")">
	<link rel="stylesheet" type="text/css" media="screen" href="@routes.Assets.at("stylesheets/bootstrap-responsive.css")">
	<link rel="stylesheet" type="text/css" media="screen" href="@routes.Assets.at("stylesheets/jquery-ui-1.9.1.custom.css")">
	<link rel="stylesheet" media="screen" href="@routes.Assets.at("stylesheets/main.css")">
	<link rel="shortcut icon" type="image/png" href="@routes.Assets.at("images/favicon.png")">
	<link rel="shortcut icon" type="image/png" href="@routes.Assets.at("img/glyphicons-halflings.png")">
	<link rel="shortcut icon" type="image/png" href="@routes.Assets.at("img/glyphicons-halflings-white.png")">
	<style type="text/css">
	.bar rect {
		fill: steelblue;
	}
	.bar text.value {
		fill: white;
	}
	.axis {
		shape-rendering: crispEdges;
	}
	.axis path {
		fill: none;
	}
	.x.axis line {
		stroke: #fff;
		stroke-opacity: .8;
	}
	.y.axis path {
		stroke: black;
	}
	</style>
</head>
<body>

	<div class="container-narrow" id="main-div">

		<div class="row-fluid">
			<div id="my-hero">
				<h1>@{if (gamePrices.isEmpty) "No Name" else gamePrices.head._1.name }</h1>
			</div>
			<div id="small-search">
				<form class="form-search" action="@routes.Application.gameP()">
					<input type="search" id="searchbox" class="input-large autocomplete" name="g" placeholder="Search for a game..." data-url="@{routes.Application.autocompleteSearch()}" autocomplete="off">
				</form>
			</div>
		</div>
		<div class="row-fluid">
			<div class="span12 well" id="recc">
				<h3>Recommendation: <font color="#51a351">buy</font> or <font color="#bd362f">don't buy</font> on Steam or neutral</h3>
			</div>
		</div>

		<hr>

		<div class="row-fluid">
			<div class="span6">
				<div id="barchart-cont"></div>
			</div>
			<div class="span6">
				<table class="table table-hover">
					<thead>
						<tr>
							<th colspan="2"><h4>Price Stats</h4></th>
							<th><h4>Store</h4></th>
							<th><h4>When</h4></th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td>Average</td>
							<td>$@nicePrice(priceStats.avg)</td>
							<td></td>
							<td></td>
						</tr>
						<tr class="success">
							<td>Lowest</td>
							<td>$@nicePrice(priceStats.min)</td>
							<td>@priceStats.smin</td>
							<td>@priceStats.minD</td>
						</tr>
						<tr class="error">
							<td>Highest</td>
							<td>$@nicePrice(priceStats.max)</td>
							<td>@priceStats.smax</td>
							<td>@priceStats.maxD</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>

		<div class="row-fluid">
			<div id="chart-cont"></div>
		</div>

	</div>

<script src="@routes.Assets.at("javascripts/jquery.min.js")"></script> 
<script src="@routes.Assets.at("javascripts/jquery-ui-1.9.1.custom.min.js")"></script> 
<script src="@routes.Assets.at("javascripts/bootstrap.min.js")"></script> 
<script src="http://code.highcharts.com/highcharts.js"></script>
<script src="http://code.highcharts.com/modules/exporting.js"></script>
<script>    
$('input.autocomplete').each( function() {
	var $input = $(this);
	var serverUrl = $input.data('url');
	$input.autocomplete({ source:serverUrl });
});
</script>
<script type="text/javascript">
$(function () {
var chart; // globally available
$(document).ready(function() {
	$.getJSON("@routes.Application.priceData(gamePrices.head._1.name)", function(data) {
		chart = new Highcharts.Chart({
			chart: {
				renderTo: 'chart-cont',
				type: 'line',
				backgroundColor: null
			},

			xAxis: {
				type: 'datetime',
            	dateTimeLabelFormats: { // don't display the dummy year
            	day: '%e. %b',
            	week: '%e. %b'
        		}
    		},

    		yAxis: {
    			title: {
    				text: 'Price'
    			}
    		},

            plotOptions: {
                line: {
                    dataLabels: {
                        enabled: true
                    }
                }
            },

    		credits: {
    			enabled: false
    		},

    		series: data
		});
	});
});
});
</script>
<script src="@routes.Assets.at("javascripts/rainbowvis.js")"></script>
<script type="text/javascript">
$(function () {
		var data  = jQuery.parseJSON('@Html(toJson(gamePrices.map(x => toJson(Map("y" -> toJson(x._2.priceOnX), "url" -> toJson(x._1.storeUrl))))).toString)');
		var names = jQuery.parseJSON('@Html(toJson(gamePrices.map(x => toJson(x._1.store))).toString)')
		var rainbow = new Rainbow();

		var j=1;
		if(names.length == 1) {
			data[0]['color'] = "#418141";
		} else {
			rainbow.setNumberRange(1, names.length);
			rainbow.setSpectrum('418141', 'ce3f38');
			for(var i=0; i<names.length; i++) {
				data[i]['color'] = "#" + rainbow.colorAt(j);
				if(i+1 < names.length)
				{
					if(data[i+1]['y'] > data[i]['y']) {
						j++;
					}
				} else {
					if(data[i]['y'] > data[i-1]['y']) {
						data[i]['color'] = "#" + rainbow.colorAt(j);
					}
				}
			}
		}


    var chart;
    $(document).ready(function() {
        chart = new Highcharts.Chart({
            chart: {
                renderTo: 'barchart-cont',
                type: 'bar',
                backgroundColor: null,
                spacingRight: 0,
                spacingLeft: 0,
                marginRight: -20,
                marginTop: 20,
                height: 28 * (names.length + 3) - 22 + 20
            },
            title: {
                text: null
            },
            xAxis: {
            	categories: names,
            	title: {
                    text: null
                },
                tickWidth: 0,
                labels: {
                	style: {
                		fontSize: '14px',
                		color: 'black'
                	}
                }
            },
            yAxis: {
            	labels: {
                	enabled: false
                },
                gridLineWidth: 0,
                lineWidth: 0,
                title: {
                	text: "Click on a bar to visit the store",
                	align: 'low'
                }
            },
            tooltip: {
            	enabled: true,
            	formatter: function (d) { return null; },
            	borderWidth: 0,
            	shadow: false,
            	backgroundColor: null
            },
            legend: {enabled: false},
            navigation: {
            	buttonOptions: {
            		enabled: false
            	}
            },
            plotOptions: {
                bar: {
                    dataLabels: {
                    	enabled: true,
                        align: 'right',
                        style: {
                    		color: '#FFFFFF',
                    		fontSize: '13px'
                    	},
                    	x: -5,
                    	y: -2,
                    	formatter: function() { return "$" + this.y }
                    },
                	groupPadding: 0,
                	pointPadding: 0.01,
                	shadow: false,
                	//color: 'darkgray',
                	cursor: 'pointer',
                	point: {
                		events: {
                			click: function (d) { location.href = this.options.url; }
                		}
                	},
                	minPointLength: 30,
                	pointWidth: 40
                }
            },
            credits: {
                enabled: false
            },
            series: [{
            	name: "Price",
            	data: data
            }]
        });
    });
    
});
    </script>
</body>
</html>